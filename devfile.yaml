schemaVersion: 2.2.0
metadata:
  name: quarkus-prj-for-z
#attributes:
#  controller.devfile.io/storage-type: ephemeral
components:
  - name: tools
    container:
      image: alm-repos.sogei.it/devfile/universal-developer-image:3.6_s390x_v1.1.2
      env:
        - name: MAVEN_OPTS
          value: " -Djava.net.useSystemProxies=true "
      endpoints:
        - exposure: none
          name: debug
          protocol: tcp
          targetPort: 5555
        - exposure: public
          name: app-be
          protocol: http
          targetPort: 8080
          path: /openapi/ui
      volumeMounts:
        - name: m2
          path: /home/user/.m2
      memoryLimit: 6G
      memoryRequest: 3G
      cpuLimit: 1500m
      cpuRequest: 400m
      mountSources: true

  - name: m2
    volume:
      size: 2G

commands:
  - id: setup-environment
    exec:
      label: 0.1 - Initial Environment Setup
      component: tools
      workingDir: ${PROJECTS_ROOT}
      commandLine: |

        # configure settings.xml and .npmrc
        setup_configurations_files(){
          MVN_SETTINGS_REMOTE="https://alm-repos.sogei.it/repository/codeready-plugins/assets/settings-https-v3-with-proxy.xml"
          mkdir -p /home/user/.m2
          wget  -q --no-check-certificate $MVN_SETTINGS_REMOTE -O /home/user/.m2/settings.xml
          
          echo registry=https://alm-repos.sogei.it/repository/npm-group/ > /home/user/.npmrc
          echo cafile=/etc/pki/ca-trust/source/anchors/alm-repos.sogei.it-ca.crt >> /home/user/.npmrc
        }
        setup_configurations_files

        # configure git credential.helper
        # git config --global credential.helper 'cache --timeout 36000'
        git clone https://SIFEntrate1Collection@dev.azure.com/SIFEntrate1Collection/TP-ENT-SA-0007/_git/mono-repo ${PROJECTS_ROOT}/monorepo
        git clone https://SIFEntrate1Collection@dev.azure.com/SIFEntrate1Collection/TP-ENT-SA-0007/_git/nuovoaccertamento-manifest ${PROJECTS_ROOT}/gitops

        # execute schema creation
        echo "Generating schema and .env file"
        [ -f ${PROJECTS_ROOT}/monorepo/scripts/init-env.sh ] &&  ${PROJECTS_ROOT}/monorepo/scripts/init-env.sh || echo "file ${PROJECTS_ROOT}/monorepo/scripts/init-env.sh not found"


